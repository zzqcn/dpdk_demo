# graph-MT

pipeline 模式的多线程 graph 应用.

---

## 原理

由 2 个 pipeline 组成:
- pipeline 0: 从网卡收包, 并分发给pipeline 1
- pipeline 1: 从pipeline 0 收包, 然后进行处理, 最后进行转发

pipeline 0 和 pipeline 1 通过队列连接. 本例中 pipeline 0 使用一个 lcore, pipeline 1 使用两个 lcore.

每个 pipeline 中都有若干个 node, 分别在每一个 lcore 中构成一个 graph.

```
     pipeline 0                   pipeline 1

                           +-----------------------------+
                           + (deque) -> (flow) -> (drop) |
                          /+-----------------------------+
+--------------------+   /
| (rx) -> (dispatch) +->+
+--------------------+   \
                          \+-----------------------------+
                           + (deque) -> (flow) -> (drop) |
                           +-----------------------------+
```


## 运行

```
$ sudo <graph_mt> -l 0,1,2,3 -- -p 0x1 -P --config "(1,0,0,1),(2,0,0,2),(2,0,0,3)"
``` 

注意使用 `-P` 参数打开混杂模式, 否则收不了包.

程序运行中会显示 graph 相关统计, 如:
```
+-------------------------------+---------------+---------------+---------------+---------------+---------------+-----------+
|Node                           |calls          |objs           |realloc_count  |objs/call      |objs/sec(10E6) |cycles/call|   
+-------------------------------+---------------+---------------+---------------+---------------+---------------+-----------+
|rx                             |526217359      |46             |2              |0.000          |0.000000       |95.0000    |
|dispatch                       |28             |46             |1              |0.000          |0.000000       |0.0000     |
|dequeue                        |1433261608     |46             |4              |0.000          |0.000000       |51.0000    |
|flow                           |16             |46             |2              |0.000          |0.000000       |0.0000     |
|drop                           |16             |46             |2              |0.000          |0.000000       |0.0000     |
+-------------------------------+---------------+---------------+---------------+---------------+---------------+-----------+
```